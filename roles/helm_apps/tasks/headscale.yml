---
- name: Create Headscale namespace
  ansible.builtin.command: kubectl create namespace {{ headscale_namespace }}
  failed_when: false
  changed_when: false
  become: no

- name: Add Headscale Helm repository
  ansible.builtin.command: helm repo add headscale https://helm.headscale.net/
  changed_when: false
  become: no

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: false
  become: no

- name: Create Headscale Helm values file
  ansible.builtin.copy:
    dest: /tmp/headscale-values.yaml
    content: |
      persistence:
        enabled: true
        size: 1Gi
        storageClass: {{ storage_class }}
      
      service:
        type: ClusterIP
        annotations:
          tailscale.com/expose: "true"
          tailscale.com/hostname: "{{ tailscale_headscale_hostname | default('headscale') }}"

      headscale:
        config:             
          derp:
            server:
              enabled: false
            urls:
              - https://controlplane.tailscale.com/derpmap/default
            auto_update_enabled: true
            update_frequency: 24h
          
          disable_check_updates: false
          
          dns:
            magic_dns: true
            base_domain: headscale.local
            nameservers:
              global:
                - 9.9.9.9
                - 149.112.112.112
            override_local_dns: true
      
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 128Mi

- name: Deploy Headscale using Helm
  ansible.builtin.command: >
    helm upgrade --install headscale headscale/headscale
    --namespace {{ headscale_namespace }}
    --values /tmp/headscale-values.yaml
    {{ '--version ' + headscale_chart_version if headscale_chart_version else '' }}
    --wait
  changed_when: true
  become: no
