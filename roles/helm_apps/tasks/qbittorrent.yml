---
- name: Create qBittorrent namespace
  ansible.builtin.command: kubectl create namespace {{ qbittorrent_namespace }}
  failed_when: false
  changed_when: false
  become: no

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: false
  become: no

- name: Create qBittorrent Helm values file
  ansible.builtin.copy:
    dest: /tmp/qbittorrent-values.yaml
    content: |
      env:
        TZ: UTC
        PUID: "1000"
        PGID: "1000"
        WEBUI_PORT: "8080"
      
      service:
        main:
          type: ClusterIP
          annotations:
            tailscale.com/expose: "true"
            tailscale.com/hostname: "{{ tailscale_qbittorrent_hostname | default('qbittorrent') }}"
          ports:
            http:
              port: 8080
        bittorrent:
          enabled: true
          type: ClusterIP
          ports:
            bittorrent:
              enabled: true
              port: 6881
              protocol: TCP
      
      persistence:
        config:
          enabled: true
          storageClass: {{ storage_class }}
          accessMode: ReadWriteOnce
          size: 1Gi
        downloads:
          enabled: true
          mountPath: /downloads
          storageClass: {{ storage_class }}
          accessMode: ReadWriteOnce
          size: 10Gi
      
      resources:
        limits:
          cpu: 1000m
          memory: 2Gi
        requests:
          cpu: 200m
          memory: 512Mi

- name: Deploy qBittorrent using Helm
  ansible.builtin.command: >
    helm upgrade --install qbittorrent gabe565/qbittorrent
    --namespace {{ qbittorrent_namespace }}
    --values /tmp/qbittorrent-values.yaml
    {{ '--version ' + qbittorrent_chart_version if qbittorrent_chart_version else '' }}
    --wait
  changed_when: true
  become: no
