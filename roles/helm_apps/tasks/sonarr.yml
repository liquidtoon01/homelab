---
- name: Create media namespace
  ansible.builtin.command: kubectl create namespace {{ sonarr_namespace }}
  failed_when: false
  changed_when: false
  become: no

- name: Create Sonarr manifest
  ansible.builtin.copy:
    dest: /tmp/sonarr-manifest.yaml
    content: |
      ---
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: sonarr-config
        namespace: {{ sonarr_namespace }}
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: {{ storage_class }}
        resources:
          requests:
            storage: 1Gi
      ---
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: sonarr-media
        namespace: {{ sonarr_namespace }}
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: {{ storage_class }}
        resources:
          requests:
            storage: 50Gi
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: sonarr
        namespace: {{ sonarr_namespace }}
        labels:
          app: sonarr
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: sonarr
        template:
          metadata:
            labels:
              app: sonarr
          spec:
            containers:
            - name: sonarr
              image: linuxserver/sonarr:latest
              ports:
              - containerPort: 8989
                name: http
              env:
              - name: PUID
                value: "1000"
              - name: PGID
                value: "1000"
              - name: TZ
                value: "UTC"
              volumeMounts:
              - name: config
                mountPath: /config
              - name: media
                mountPath: /media
            volumes:
            - name: config
              persistentVolumeClaim:
                claimName: sonarr-config
            - name: media
              persistentVolumeClaim:
                claimName: sonarr-media
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: sonarr
        namespace: {{ sonarr_namespace }}
        annotations:
          tailscale.com/expose: "true"
          tailscale.com/hostname: "{{ tailscale_sonarr_hostname | default('sonarr') }}"
      spec:
        type: LoadBalancer
        selector:
          app: sonarr
        ports:
        - name: http
          port: 8989
          targetPort: 8989

- name: Deploy Sonarr using kubectl
  ansible.builtin.command: kubectl apply -f /tmp/sonarr-manifest.yaml
  changed_when: true
  become: no

- name: Wait for Sonarr to be ready
  ansible.builtin.command: kubectl -n {{ sonarr_namespace }} wait --for=condition=available deployment/sonarr --timeout=300s
  changed_when: false
  become: no
  failed_when: false
