---
- name: Create Sonarr namespace
  ansible.builtin.command: kubectl create namespace {{ sonarr_namespace }}
  failed_when: false
  changed_when: false
  become: no

- name: Create Sonarr PVCs manifest
  ansible.builtin.copy:
    dest: /tmp/sonarr-pvcs.yaml
    content: |
      ---
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: sonarr-config
        namespace: {{ sonarr_namespace }}
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: {{ storage_class }}
        resources:
          requests:
            storage: 1Gi
      ---
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: sonarr-media
        namespace: {{ sonarr_namespace }}
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: {{ storage_class }}
        resources:
          requests:
            storage: 50Gi
  become: no

- name: Apply Sonarr PVCs
  ansible.builtin.command: kubectl apply -f /tmp/sonarr-pvcs.yaml
  changed_when: true
  become: no

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: false
  become: no

- name: Create Sonarr Helm values file
  ansible.builtin.copy:
    dest: /tmp/sonarr-values.yaml
    content: |
      env:
        TZ: UTC
      
      service:
        main:
          type: LoadBalancer
          annotations:
            tailscale.com/expose: "true"
            tailscale.com/hostname: "{{ tailscale_sonarr_hostname | default('sonarr') }}"
          ports:
            http:
              port: 8989
      
      persistence:
        config:
          enabled: true
          existingClaim: sonarr-config
        media:
          enabled: true
          existingClaim: sonarr-media
          mountPath: /media
      
      resources:
        limits:
          cpu: 1000m
          memory: 2Gi
        requests:
          cpu: 100m
          memory: 512Mi

- name: Deploy Sonarr using Helm
  ansible.builtin.command: >
    helm upgrade --install sonarr pree/sonarr
    --namespace {{ sonarr_namespace }}
    --values /tmp/sonarr-values.yaml
    {{ '--version ' + sonarr_chart_version if sonarr_chart_version else '' }}
    --wait
  changed_when: true
  become: no
