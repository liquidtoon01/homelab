---
- name: Create Tailscale operator namespace
  ansible.builtin.command: kubectl create namespace tailscale
  failed_when: false
  changed_when: false
  become: no

- name: Deploy Tailscale operator manifest
  ansible.builtin.shell: |
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: Secret
    metadata:
      name: operator-oauth
      namespace: tailscale
    stringData:
      client_id: "{{ tailscale_oauth_client_id }}"
      client_secret: "{{ tailscale_oauth_client_secret }}"
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: operator
      namespace: tailscale
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: tailscale-operator
    rules:
    - apiGroups: [""]
      resources: ["secrets", "services", "serviceaccounts"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    - apiGroups: ["apps"]
      resources: ["deployments", "statefulsets"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    - apiGroups: [""]
      resources: ["events"]
      verbs: ["create", "patch"]
    - apiGroups: ["networking.k8s.io"]
      resources: ["ingresses", "ingressclasses"]
      verbs: ["get", "list", "watch", "update", "patch"]
    - apiGroups: ["networking.k8s.io"]
      resources: ["ingresses/status"]
      verbs: ["update", "patch"]
    - apiGroups: [""]
      resources: ["nodes"]
      verbs: ["get", "list", "watch"]
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: tailscale-operator
    subjects:
    - kind: ServiceAccount
      name: operator
      namespace: tailscale
    roleRef:
      kind: ClusterRole
      name: tailscale-operator
      apiGroup: rbac.authorization.k8s.io
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: operator
      namespace: tailscale
    rules:
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    - apiGroups: [""]
      resources: ["serviceaccounts"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    - apiGroups: ["apps"]
      resources: ["statefulsets"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: operator
      namespace: tailscale
    subjects:
    - kind: ServiceAccount
      name: operator
    roleRef:
      kind: Role
      name: operator
      apiGroup: rbac.authorization.k8s.io
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: operator
      namespace: tailscale
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: tailscale-operator
      template:
        metadata:
          labels:
            app: tailscale-operator
        spec:
          dnsPolicy: Default
          serviceAccountName: operator
          containers:
          - name: operator
            image: tailscale/k8s-operator:unstable
            env:
            - name: OPERATOR_HOSTNAME
              value: "{{ tailscale_operator_hostname | default('ts-operator') }}"
            - name: OPERATOR_SECRET
              value: operator
            - name: OPERATOR_LOGGING
              value: info
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CLIENT_ID_FILE
              value: /oauth/client_id
            - name: CLIENT_SECRET_FILE
              value: /oauth/client_secret
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: TS_KUBE_SECRET
              value: operator
            volumeMounts:
            - name: oauth
              mountPath: /oauth
              readOnly: true
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 128Mi
          volumes:
          - name: oauth
            secret:
              secretName: operator-oauth
    EOF
  args:
    executable: /bin/bash
  changed_when: true
  become: no
  when:
    - tailscale_oauth_client_id is defined
    - tailscale_oauth_client_secret is defined
    - tailscale_oauth_client_id | length > 0
    - tailscale_oauth_client_secret | length > 0

- name: Display Tailscale operator skip message
  ansible.builtin.debug:
    msg: "Skipping Tailscale operator deployment - OAuth credentials not configured. See docs/tailscale-operator.md for setup instructions."
  when: >
    tailscale_oauth_client_id is not defined or
    tailscale_oauth_client_secret is not defined or
    tailscale_oauth_client_id | length == 0 or
    tailscale_oauth_client_secret | length == 0
