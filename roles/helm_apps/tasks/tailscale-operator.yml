---
- name: Create Tailscale operator namespace
  ansible.builtin.command: kubectl create namespace tailscale
  failed_when: false
  changed_when: false
  become: no

- name: Create Tailscale operator values file
  ansible.builtin.copy:
    dest: /tmp/tailscale-operator-values.yaml
    content: |
      oauth:
        clientId: "{{ tailscale_oauth_client_id }}"
        clientSecret: "{{ tailscale_oauth_client_secret }}"
      
      apiServerProxyConfig:
        mode: "true"
      
      operatorConfig:
        image:
          tag: "unstable"
        hostname: "{{ tailscale_operator_hostname | default('ts-operator') }}"
        dnsPolicy: Default
      
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 128Mi
  when:
    - tailscale_oauth_client_id is defined
    - tailscale_oauth_client_secret is defined
    - tailscale_oauth_client_id | length > 0
    - tailscale_oauth_client_secret | length > 0

- name: Deploy Tailscale operator using Helm
  ansible.builtin.command: >
    helm upgrade --install tailscale-operator tailscale/tailscale-operator
    --namespace tailscale
    --values /tmp/tailscale-operator-values.yaml
    {{ '--version ' + tailscale_operator_chart_version if tailscale_operator_chart_version else '' }}
    --wait
  changed_when: true
  become: no
  when:
    - tailscale_oauth_client_id is defined
    - tailscale_oauth_client_secret is defined
    - tailscale_oauth_client_id | length > 0
    - tailscale_oauth_client_secret | length > 0

- name: Display Tailscale operator skip message
  ansible.builtin.debug:
    msg: "Skipping Tailscale operator deployment - OAuth credentials not configured. See docs/tailscale-operator.md for setup instructions."
  when: >
    tailscale_oauth_client_id is not defined or
    tailscale_oauth_client_secret is not defined or
    tailscale_oauth_client_id | length == 0 or
    tailscale_oauth_client_secret | length == 0
