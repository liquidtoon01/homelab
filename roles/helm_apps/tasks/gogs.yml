---
- name: Create Gogs namespace
  ansible.builtin.command: kubectl create namespace {{ gogs_namespace }}
  failed_when: false
  changed_when: false
  become: no

- name: Add Gogs Helm repository
  ansible.builtin.command: helm repo add keyporttech https://keyporttech.github.io/helm-charts/
  changed_when: false
  become: no

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: false
  become: no

- name: Create Gogs Helm values file
  ansible.builtin.copy:
    dest: /tmp/gogs-values.yaml
    content: |
      # PostgreSQL database configuration
      dbType: postgres
      useInPodPostgres: true
      
      inPodPostgres:
        postgresDatabase: gogs
      
      # Persistent storage
      persistence:
        enabled: true
        gogsSize: 10Gi
        postgresSize: 5Gi
        storageClass: {{ storage_class }}
        accessMode: ReadWriteOnce
      
      # Service configuration
      service:
        http:
          type: ClusterIP
          port: 3000
          svc_annotations:
            tailscale.com/expose: "true"
            tailscale.com/hostname: "{{ tailscale_gogs_hostname | default('gogs') }}"
        ssh:
          type: ClusterIP
          port: 22
          svc_annotations:
            tailscale.com/expose: "true"
            tailscale.com/hostname: "{{ tailscale_gogs_ssh_hostname | default('gogs-ssh') }}"
      
      # Resource limits
      resources:
        gogs:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 2Gi
        postgres:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi

- name: Deploy Gogs using Helm
  ansible.builtin.command: >
    helm upgrade --install gogs keyporttech/gogs
    --namespace {{ gogs_namespace }}
    --values /tmp/gogs-values.yaml
    {{ '--version ' + gogs_chart_version if gogs_chart_version else '' }}
    --wait
  changed_when: true
  become: no
