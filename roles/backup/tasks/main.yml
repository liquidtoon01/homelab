---
- name: Set backup filename
  ansible.builtin.set_fact:
    backup_filename: "minikube-volumes-backup-{{ ansible_facts.date_time.iso8601_basic_short }}.zip"

- name: Check if backup source directory exists
  ansible.builtin.stat:
    path: "{{ backup_source_dir }}"
  register: backup_source

- name: Display backup source status
  ansible.builtin.debug:
    msg: "Backup source: {{ backup_source_dir }} - Exists: {{ backup_source.stat.exists | default(false) }} - Readable: {{ backup_source.stat.readable | default(false) }}"

- name: Fail if backup source does not exist
  ansible.builtin.fail:
    msg: "Backup source directory {{ backup_source_dir }} does not exist or is not accessible"
  when: not backup_source.stat.exists or not backup_source.stat.readable

- name: Check if backup source has contents
  ansible.builtin.find:
    paths: "{{ backup_source_dir }}"
    file_type: any
  register: source_contents

- name: Display directory contents count
  ansible.builtin.debug:
    msg: "Found {{ source_contents.matched }} items in {{ backup_source_dir }}"

- name: Create backup archive
  ansible.builtin.archive:
    path: "{{ backup_source_dir }}/*"
    dest: "{{ backup_temp_dir }}/{{ backup_filename }}"
    format: zip
  changed_when: true

- name: Check if backup file was created
  ansible.builtin.stat:
    path: "{{ backup_temp_dir }}/{{ backup_filename }}"
  register: backup_file

- name: Display backup file size
  ansible.builtin.debug:
    msg: "Backup created: {{ backup_temp_dir }}/{{ backup_filename }} ({{ (backup_file.stat.size / 1024 / 1024) | round(2) }} MB)"
  when: backup_file.stat.exists

- name: Check if Tailscale is running
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Send backup via Tailscale taildrop
  ansible.builtin.command:
    cmd: "tailscale file cp {{ backup_temp_dir }}/{{ backup_filename }} {{ tailscale_target_ip }}:"
  when: tailscale_status.rc == 0
  changed_when: true

- name: Display taildrop status
  ansible.builtin.debug:
    msg: "Backup sent to {{ tailscale_target_ip }} via Tailscale taildrop"
  when: tailscale_status.rc == 0

- name: Warning if Tailscale is not running
  ansible.builtin.debug:
    msg: "WARNING: Tailscale is not running. Backup created at {{ backup_temp_dir }}/{{ backup_filename }} but not sent."
  when: tailscale_status.rc != 0

- name: Remove backup file from temp directory
  ansible.builtin.file:
    path: "{{ backup_temp_dir }}/{{ backup_filename }}"
    state: absent
  when: tailscale_status.rc == 0
